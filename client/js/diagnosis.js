document.addEventListener('DOMContentLoaded', function() {
    const diagnosisForm = document.getElementById('diagnosisForm');
    const resultContainer = document.getElementById('resultContainer');
    const resultContent = document.getElementById('resultContent');
    
    diagnosisForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        showLoading();

        setTimeout(fetchDiagnosisResult, 2000); 
    });
    
    function validateForm() {
        const age = document.getElementById('age').value;
        const bmi = document.getElementById('bmi').value;
        const bloodPressure = document.getElementById('blood_pressure').value;
        const skinThickness = document.getElementById('skin_thickness').value;
        const glucose = document.getElementById('glucose').value;
        const insulin = document.getElementById('insulin').value;
        const diabetesPedigreeFunction = document.getElementById('diabetesPedigreeFunction').value;
        const pregnancies = document.getElementById('pregnancies').value;
    
        if (
            !age || !bmi || !bloodPressure || !skinThickness ||
            !glucose || !insulin || !diabetesPedigreeFunction || !pregnancies
        ) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin.');
            return false;
        }
    
        return true;
    }
    
    function showLoading() {
        resultContainer.classList.remove('hidden');
        resultContent.innerHTML = `
            <div class="flex justify-center items-center py-4">
                <svg class="animate-spin h-8 w-8 text-primary light:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-gray-700 light:text-gray-300">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</span>
            </div>
        `;
    }
    
    function fetchDiagnosisResult() {
        fetch('http://127.0.0.1:5000/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pregnancies: parseInt(document.getElementById('pregnancies').value),
                glucose: parseInt(document.getElementById('glucose').value),
                blood_pressure: parseInt(document.getElementById('blood_pressure').value),
                skin_thickness: parseInt(document.getElementById('skin_thickness').value),
                insulin: parseInt(document.getElementById('insulin').value),
                bmi: parseFloat(document.getElementById('bmi').value),
                diabetes_pedigree: parseFloat(document.getElementById('diabetesPedigreeFunction').value),
                age: parseInt(document.getElementById('age').value)
            }),
        })
        .then(response => {
            console.log("Response object:", response);
            if (!response.ok) {
                throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server");
            }
            return response.json();
        })
        .then(data => {
            console.log("Data nh·∫≠n v·ªÅ:", data);
            displayResult(data);  
        })
        .catch(error => {
            console.error("C√≥ l·ªói x·∫£y ra:", error);
            resultContent.innerHTML = `
                <div class="p-4 bg-red-50 light:bg-red-900/30 rounded-lg text-red-600 light:text-red-400">
                    ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ch·∫©n ƒëo√°n. Vui l√≤ng th·ª≠ l·∫°i sau.
                </div>
            `;
        });
    }
    
    function displayResult(data) {
        const percentage = data.risk_percentage;
        let riskLevel = '';
        let riskClass = '';
        let riskDescription = '';
        let recommendation = '';
    
        if (percentage >= 75) {
            // M·ª©c NGUY C∆† CAO
            riskLevel = "R·∫§T CAO";
            riskClass = "text-red-700 light:text-red-400";
            riskDescription = `
                H·ªá th·ªëng ch·∫©n ƒëo√°n b·∫°n c√≥ <strong>${percentage}%</strong> kh·∫£ nƒÉng m·∫Øc b·ªánh <strong>TI·ªÇU ƒê∆Ø·ªúNG</strong>.
                ƒê√¢y l√† <strong class="uppercase">c·∫£nh b√°o y t·∫ø nghi√™m tr·ªçng</strong>. N·∫øu kh√¥ng ƒëi·ªÅu tr·ªã s·ªõm, b·ªánh ti·ªÉu ƒë∆∞·ªùng c√≥ th·ªÉ d·∫´n ƒë·∫øn:
                <ul class="list-disc pl-5 mt-2 text-sm">
                    <li>M√π l√≤a</li>
                    <li>Suy th·∫≠n, ph·∫£i ch·∫°y th·∫≠n nh√¢n t·∫°o</li>
                    <li>Ho·∫°i t·ª≠ chi, nguy c∆° ƒëo·∫°n chi</li>
                    <li>ƒê·ªôt qu·ªµ ho·∫∑c nh·ªìi m√°u c∆° tim</li>
                </ul>
            `;
            recommendation = `
                <div class="mt-4 p-4 bg-red-100 light:bg-red-900/30 rounded-lg text-red-800 light:text-red-300 border border-red-400 light:border-red-600">
                    üö® <strong>Khuy·∫øn ngh·ªã kh·∫©n c·∫•p:</strong> Vui l√≤ng ƒë·∫øn b·ªánh vi·ªán chuy√™n khoa n·ªôi ti·∫øt ƒë·ªÉ l√†m x√©t nghi·ªám ƒë∆∞·ªùng huy·∫øt, HbA1c v√† ƒë∆∞·ª£c t∆∞ v·∫•n ƒëi·ªÅu tr·ªã. Kh√¥ng ƒë∆∞·ª£c ch·ªß quan!
                </div>
            `;
        } else if (percentage >= 50) {
            // M·ª©c NGUY C∆† TRUNG B√åNH
            riskLevel = "TRUNG B√åNH";
            riskClass = "text-orange-600 light:text-orange-400";
            riskDescription = `
                H·ªá th·ªëng cho th·∫•y b·∫°n c√≥ <strong>${percentage}%</strong> nguy c∆° m·∫Øc b·ªánh ti·ªÉu ƒë∆∞·ªùng. 
                B·∫°n hi·ªán ƒëang ·ªü <strong>giai ƒëo·∫°n ti·ªÅn ti·ªÉu ƒë∆∞·ªùng</strong> ‚Äì n·∫øu kh√¥ng ƒëi·ªÅu ch·ªânh l·ªëi s·ªëng, b·ªánh c√≥ th·ªÉ ph√°t tri·ªÉn √¢m th·∫ßm v√† g√¢y bi·∫øn ch·ª©ng sau v√†i nƒÉm.
            `;
            recommendation = `
                <div class="mt-4 p-4 bg-orange-100 light:bg-orange-900/30 rounded-lg text-orange-800 light:text-orange-300 border border-orange-400 light:border-orange-600">
                    ‚ö†Ô∏è <strong>Khuy·∫øn ngh·ªã:</strong> H·∫°n ch·∫ø ƒë∆∞·ªùng, tinh b·ªôt, n∆∞·ªõc ng·ªçt v√† b·∫Øt ƒë·∫ßu t·∫≠p luy·ªán ƒë·ªÅu ƒë·∫∑n m·ªói ng√†y. Theo d√µi ƒë∆∞·ªùng huy·∫øt √≠t nh·∫•t m·ªói 3 th√°ng.
                </div>
            `;
        } else {
            // M·ª©c TH·∫§P
            riskLevel = "TH·∫§P";
            riskClass = "text-green-600 light:text-green-400";
            riskDescription = `
                B·∫°n ch·ªâ c√≥ <strong>${percentage}%</strong> nguy c∆° m·∫Øc b·ªánh ti·ªÉu ƒë∆∞·ªùng. ƒê√¢y l√† d·∫•u hi·ªáu t√≠ch c·ª±c, 
                nh∆∞ng v·∫´n c·∫ßn duy tr√¨ l·ªëi s·ªëng l√†nh m·∫°nh v√¨ ti·ªÉu ƒë∆∞·ªùng c√≥ th·ªÉ ph√°t sinh do tu·ªïi t√°c, di truy·ªÅn v√† th√≥i quen x·∫•u k√©o d√†i.
            `;
            recommendation = `
                <div class="mt-4 p-4 bg-green-100 light:bg-green-900/30 rounded-lg text-green-800 light:text-green-300 border border-green-400 light:border-green-600">
                    ‚úÖ <strong>L·ªùi khuy√™n:</strong> Ti·∫øp t·ª•c duy tr√¨ ƒÉn u·ªëng khoa h·ªçc, t·∫≠p th·ªÉ d·ª•c, v√† kh√°m s·ª©c kh·ªèe ƒë·ªãnh k·ª≥.
                </div>
            `;
        }
    
        resultContent.innerHTML = `
            <div class="mb-6 text-center">
                <div class="inline-block rounded-full bg-gray-100 light:bg-gray-700 p-3 mb-3">
                    <svg class="h-8 w-8 ${riskClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h4 class="text-lg font-semibold mb-1">
                    Nguy c∆° ti·ªÉu ƒë∆∞·ªùng: <span class="${riskClass}">${riskLevel}</span>
                </h4>
            </div>
            <p class="text-gray-700 light:text-gray-300 mb-4">${riskDescription}</p>
            ${recommendation}
        `;
    }
    
});
